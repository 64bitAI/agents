#!/usr/bin/env python3
"""
Chain agents together, passing output from origin to target
Usage: /chain origin target "query"

---
description: Chain agents together, passing output from origin to target
---
"""

import sys
import json
import time
from datetime import datetime
from pathlib import Path

class AgentChain:
    def __init__(self):
        self.claude_dir = Path(".claude")
        self.valid_agents = ["risk", "trader", "technicals", "fundamentals", "quant", "sentiment", "portfolio"]
    
    def validate_agents(self, agents):
        """Validate that requested agents exist"""
        for agent in agents:
            if agent not in self.valid_agents:
                print(f"‚ùå Error: Unknown agent '{agent}'")
                print(f"Valid agents: {', '.join(self.valid_agents)}")
                return False
        return True
    
    def save_chain_context(self, origin_agent, target_agent, query, origin_output):
        """Save chain context for debugging"""
        chain_dir = self.claude_dir / "temp" / "chains"
        chain_dir.mkdir(parents=True, exist_ok=True)
        
        chain_id = f"{origin_agent}_{target_agent}_{int(time.time())}"
        context = {
            "chain_id": chain_id,
            "timestamp": datetime.now().isoformat(),
            "origin_agent": origin_agent,
            "target_agent": target_agent,
            "original_query": query,
            "origin_output": origin_output
        }
        
        with open(chain_dir / f"{chain_id}.json", 'w') as f:
            json.dump(context, f, indent=2)
        
        return chain_id
    
    def execute_chain(self, origin, target, query):
        """Execute agent chain"""
        print(f"üîó Agent Chain: {origin} ‚Üí {target}")
        print(f"Query: {query}")
        print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M ET')}")
        print("=" * 60)
        
        # Step 1: Run origin agent
        print(f"\nüìä Step 1: {origin.upper()} Analysis")
        print("-" * 40)
        
        # Actually invoke the origin agent using Task tool
        origin_context = f"""
Query: {query}

Context for {origin} agent:
- Provide your analysis of the above query
- Reference current portfolio state (@.claude/context/portfolio_state.md)
- Consider current market conditions (@.claude/context/market_conditions.md)
- Check active alerts (@.claude/alerts/active.md)
- Use your structured markdown report format
- Focus on insights relevant to passing to {target} agent
        """
        
        print(f"Use agent {origin} with the following context:")
        print(origin_context)
        print("")
        print("Please provide your analysis, then I will pass it to the target agent.")
        print("")
        print("---")
        print("")
        print("After receiving the origin agent's response, continue below:")
        print("")
        
        # Placeholder for origin output - in practice this would be captured
        mock_origin_output = "[ORIGIN AGENT RESPONSE WILL BE CAPTURED HERE]"
        
        # Step 2: Pass to target agent
        print(f"\nüéØ Step 2: {target.upper()} Analysis")
        print("-" * 40)
        
        target_context = f"""
Original query: {query}

Previous analysis from {origin} agent:
{mock_origin_output}

Context for {target} agent:
- Review the {origin} agent's analysis above
- Add your specialized {target} perspective to the query
- Reference current portfolio state (@.claude/context/portfolio_state.md)
- Consider current market conditions (@.claude/context/market_conditions.md)
- Check active alerts (@.claude/alerts/active.md)
- Note areas where you agree or disagree with the {origin} analysis
- Provide combined insights and recommendations
- Use your structured markdown report format
        """
        
        print(f"Use agent {target} with the following context:")
        print(target_context)
        print("")
        
        # Save chain context
        chain_id = self.save_chain_context(origin, target, query, mock_origin_output)
        
        print(f"\n‚úÖ Chain Complete: {origin} ‚Üí {target}")
        print(f"Chain ID: {chain_id}")
        print(f"Context saved to: .claude/temp/chains/{chain_id}.json")
        print("")
        print("üí° Next steps:")
        print("  - Review both agent perspectives")
        print("  - Use /portfolio to discuss findings with PM")
        print("  - Consider additional agent consultation if needed")

def main():
    if len(sys.argv) < 4:
        print("Usage: /chain origin target \"query\"")
        print("")
        print("Examples:")
        print("  /chain risk technicals \"NVDA position analysis\"")
        print("  /chain sentiment fundamentals \"AAPL earnings reaction\"")
        print("  /chain technicals risk \"breakout trade sizing\"")
        print("")
        print("Available agents:")
        print("  risk, trader, technicals, fundamentals, quant, sentiment, portfolio")
        sys.exit(1)
    
    origin = sys.argv[1].lower()
    target = sys.argv[2].lower()
    query = sys.argv[3]
    
    chain = AgentChain()
    
    # Validate agents
    if not chain.validate_agents([origin, target]):
        sys.exit(1)
    
    if origin == target:
        print("‚ùå Error: Origin and target agents cannot be the same")
        sys.exit(1)
    
    # Execute chain
    chain.execute_chain(origin, target, query)

if __name__ == "__main__":
    main()